<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI English Trainer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-gray-100 p-4">

<h1 class="text-xl font-bold mb-1">üß† AI English Trainer</h1>
<p id="levelText" class="text-sm text-gray-400 mb-2"></p>

<!-- CHAT -->
<div id="chat" class="bg-gray-800 p-3 rounded mb-3 h-48 overflow-y-auto text-sm"></div>

<!-- FEEDBACK BOXES -->
<div class="grid grid-cols-1 gap-2 mb-3">
  <div id="correction" class="bg-gray-800 p-2 rounded text-sm"></div>
  <div id="pronunciation" class="bg-gray-800 p-2 rounded text-sm"></div>
  <div id="reply" class="bg-gray-800 p-2 rounded text-sm"></div>
</div>

<!-- GRAPH -->
<canvas id="chart" height="120" class="bg-gray-800 rounded mb-3"></canvas>

<div id="feedback" class="text-xs mb-3"></div>

<!-- CONTROLS -->
<div class="flex gap-2 mb-3">
  <button id="speakBtn" class="bg-blue-600 px-3 py-2 rounded">üé§ Speak</button>
  <button id="hearBtn" class="bg-green-600 px-3 py-2 rounded">üîä Hear AI</button>
  <button id="resetBtn" class="bg-red-600 px-3 py-2 rounded">‚ôªÔ∏è Reset</button>
</div>

<script>
/* ================= CONFIG ================= */
const WORKER_URL = "https://english-ai.xvbw97yrx9.workers.dev";
const LEVELS = ["A1","A2","B1","B2","C1"];

/* ================= STATE ================= */
let state = JSON.parse(localStorage.getItem("trainerState")) || {
  level: "A1",
  history: []
};

let lastAIReply = "";
let audioUnlocked = false;

/* ================= DOM ================= */
const chat = document.getElementById("chat");
const feedback = document.getElementById("feedback");
const levelText = document.getElementById("levelText");

/* ================= INIT ================= */
initVoices();
updateUI();

/* =======================
   VOZ (TTS) ‚Äî SAFARI NATURAL
======================= */
let selectedVoice = null;

function initVoices() {
  const preferred = ['Samantha', 'Daniel', 'Aaron'];

  function pickVoice() {
    const voices = speechSynthesis.getVoices();
    if (!voices.length) return;

    selectedVoice =
      voices.find(v => preferred.includes(v.name) && v.lang.startsWith('en')) ||
      voices.find(v => v.lang === 'en-US') ||
      voices[0];
  }

  pickVoice();
  speechSynthesis.onvoiceschanged = pickVoice;
}

function speakText(text) {
  if (!text) return;

  speechSynthesis.cancel();
  speechSynthesis.resume(); // üîë ESSENCIAL NO SAFARI

  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US';
  if (selectedVoice) u.voice = selectedVoice;
  u.rate = 0.95;
  u.pitch = 1.0;

  speechSynthesis.speak(u);
}

/* ================= STT ================= */
document.getElementById("speakBtn").onclick = () => {
  const SR = window.webkitSpeechRecognition;
  if (!SR) return alert("STT not supported");

  const rec = new SR();
  rec.lang = "en-US";
  rec.interimResults = false;

  feedback.textContent = "üéôÔ∏è Listening‚Ä¶";

  rec.onresult = e => {
    const spoken = e.results[0][0].transcript.trim();
    addChat("You", spoken);
    askAI(spoken);
  };

  rec.start();
};

/* ================= AI ================= */
async function askAI(text) {
  feedback.textContent = "ü§ñ Thinking‚Ä¶";

  const prompt = `
Return STRICT JSON:
{
 "correction": "...",
 "pronunciation": "...",
 "reply": "...",
 "cefr": 0-1
}

You are a strict American English teacher.
Student level: ${state.level}
Student said: "${text}"
`;

  try {
    const res = await fetch(WORKER_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ prompt })
    });

    const data = await res.json();
    const parsed = JSON.parse(data.reply);

    document.getElementById("correction").innerHTML =
      "<b>Correction:</b> " + parsed.correction;

    document.getElementById("pronunciation").innerHTML =
      "<b>Pronunciation:</b> " + parsed.pronunciation;

    document.getElementById("reply").innerHTML =
      "<b>Reply:</b> " + parsed.reply;

    lastAIReply = parsed.reply;

    updateCEFR(parsed.cefr);
    drawChart();

    if (audioUnlocked) speakText(lastAIReply);

    feedback.textContent = "Your turn.";

  } catch {
    feedback.textContent = "AI unavailable.";
  }
}

/* ================= CEFR ================= */
function updateCEFR(score){
  state.history.push(score);
  const recent = state.history.slice(-5);
  const avg = recent.reduce((a,b)=>a+b,0)/recent.length;

  const idx = Math.min(
    LEVELS.length-1,
    Math.max(0, Math.round(avg*(LEVELS.length-1)))
  );

  state.level = LEVELS[idx];
  localStorage.setItem("trainerState",JSON.stringify(state));
  updateUI();
}

/* ================= GRAPH ================= */
function drawChart(){
  const c = document.getElementById("chart");
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);

  ctx.strokeStyle="#4ade80";
  ctx.beginPath();

  state.history.slice(-20).forEach((v,i)=>{
    const x = i*(c.width/20);
    const y = c.height - v*c.height;
    i?ctx.lineTo(x,y):ctx.moveTo(x,y);
  });

  ctx.stroke();
}

/* ================= AUDIO UNLOCK ================= */
document.getElementById("hearBtn").onclick = () => {
  if (!audioUnlocked) {
    speechSynthesis.speak(new SpeechSynthesisUtterance("."));
    audioUnlocked = true;
  }
  speakText(lastAIReply);
};

/* ================= UI ================= */
function addChat(who,text){
  const d=document.createElement("div");
  d.className = who==="You"?"text-blue-400":"text-green-400";
  d.textContent = who+": "+text;
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}

function updateUI(){
  levelText.textContent = "Level: " + state.level;
}

/* ================= RESET ================= */
document.getElementById("resetBtn").onclick=()=>{
  if(confirm("Reset all progress?")){
    localStorage.clear();
    location.reload();
  }
};
</script>

</body>
</html>
