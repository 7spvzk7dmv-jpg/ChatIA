<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI English Trainer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-gray-100 p-4">

<h1 class="text-xl font-bold mb-1">üß† AI English Trainer</h1>
<p id="levelText" class="text-sm text-gray-400 mb-2"></p>

<div id="chat" class="bg-gray-800 p-3 rounded mb-3 h-56 overflow-y-auto text-sm"></div>

<div class="grid grid-cols-1 gap-2 mb-3">
  <div id="correction" class="bg-gray-800 p-2 rounded text-sm"></div>
  <div id="pronunciation" class="bg-gray-800 p-2 rounded text-sm"></div>
  <div id="reply" class="bg-gray-800 p-2 rounded text-sm"></div>
</div>

<canvas id="chart" height="120" class="bg-gray-800 rounded mb-3"></canvas>

<div id="feedback" class="text-xs mb-3"></div>

<div class="flex gap-2 mb-3">
  <button id="speakBtn" class="bg-blue-600 px-3 py-2 rounded">üé§ Speak</button>
  <button id="hearBtn" class="bg-green-600 px-3 py-2 rounded">üîä Hear AI</button>
  <button id="resetBtn" class="bg-red-600 px-3 py-2 rounded">‚ôªÔ∏è Reset</button>
</div>

<script>
const WORKER_URL = "https://english-ai.xvbw97yrx9.workers.dev";
const LEVELS = ["A1","A2","B1","B2","C1"];

let state = JSON.parse(localStorage.getItem("trainerState")) || {
  level: "A1",
  history: []
};

let lastAIReply = "";
let audioUnlocked = false;

/* ================= STT ================= */
document.getElementById("speakBtn").onclick = () => {
  const SR = window.webkitSpeechRecognition;
  if (!SR) return alert("STT not supported");

  const rec = new SR();
  rec.lang = "en-US";

  rec.onresult = e => {
    const spoken = e.results[0][0].transcript.trim();
    addChat("You", spoken);
    askAI(spoken);
  };

  rec.start();
};

/* ================= AI ================= */
async function askAI(text) {
  const prompt = `
You are a strict English teacher.
Return JSON with:
correction, pronunciation_tips, reply, cefr_score (0-1)

Student said: "${text}"
`;

  const res = await fetch(WORKER_URL,{
    method:"POST",
    headers:{ "Content-Type":"application/json" },
    body: JSON.stringify({ prompt })
  });

  const data = await res.json();
  let parsed;

  try { parsed = JSON.parse(data.reply); }
  catch { return; }

  document.getElementById("correction").innerHTML =
    "<b>Correction:</b> " + parsed.correction;

  document.getElementById("pronunciation").innerHTML =
    "<b>Pronunciation:</b> " + parsed.pronunciation_tips;

  document.getElementById("reply").innerHTML =
    "<b>Reply:</b> " + parsed.reply;

  lastAIReply = parsed.reply;

  updateCEFR(parsed.cefr_score);
  drawChart();

  if (audioUnlocked) speak(lastAIReply);
}

/* ================= CEFR ================= */
function updateCEFR(score){
  state.history.push(score);
  const avg = state.history.slice(-5).reduce((a,b)=>a+b,0)/Math.min(5,state.history.length);

  let idx = Math.round(avg*(LEVELS.length-1));
  state.level = LEVELS[idx];

  localStorage.setItem("trainerState",JSON.stringify(state));
  document.getElementById("levelText").textContent = "Level: " + state.level;
}

/* ================= CHART ================= */
function drawChart(){
  const c = document.getElementById("chart");
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);

  ctx.strokeStyle="#4ade80";
  ctx.beginPath();

  state.history.slice(-20).forEach((v,i)=>{
    const x = i*(c.width/20);
    const y = c.height - v*c.height;
    i?ctx.lineTo(x,y):ctx.moveTo(x,y);
  });

  ctx.stroke();
}

/* ================= TTS ================= */
document.getElementById("hearBtn").onclick = () => {
  if(!audioUnlocked){
    speechSynthesis.speak(new SpeechSynthesisUtterance("."));
    audioUnlocked=true;
  }
  speak(lastAIReply);
};

function speak(t){
  if(!t) return;
  const u = new SpeechSynthesisUtterance(t);
  u.lang="en-US";
  u.rate=0.92;
  const voices = speechSynthesis.getVoices();
  u.voice = voices.find(v=>v.name==="Samantha") || voices.find(v=>v.lang==="en-US");
  speechSynthesis.cancel();
  speechSynthesis.speak(u);
}

/* ================= UI ================= */
function addChat(who,text){
  const d=document.createElement("div");
  d.className = who==="You"?"text-blue-400":"text-green-400";
  d.textContent = who+": "+text;
  chat.appendChild(d);
}

/* ================= RESET ================= */
document.getElementById("resetBtn").onclick=()=>{
  if(confirm("Reset everything?")){
    localStorage.clear();
    location.reload();
  }
};
</script>

</body>
</html>
