<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>AI English Trainer</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<script src="https://cdn.tailwindcss.com"></script>
</head>

<body class="bg-gray-900 text-gray-100 p-4">

<h1 class="text-xl font-bold mb-1">üß† AI English Trainer</h1>
<p id="levelText" class="text-sm text-gray-400 mb-2"></p>

<!-- CHAT -->
<div id="chat" class="bg-gray-800 p-3 rounded mb-3 h-48 overflow-y-auto text-sm"></div>

<!-- FEEDBACK BOXES -->
<div class="grid grid-cols-1 gap-2 mb-3">
  <div id="correction" class="bg-gray-800 p-2 rounded text-sm"></div>
  <div id="pronunciation" class="bg-gray-800 p-2 rounded text-sm"></div>
  <div id="reply" class="bg-gray-800 p-2 rounded text-sm"></div>
</div>

<!-- GRAPH -->
<canvas id="chart" height="120" class="bg-gray-800 rounded mb-3"></canvas>

<div id="feedback" class="text-xs mb-3"></div>

<!-- CONTROLS -->
<div class="flex gap-2 mb-3">
  <button id="speakBtn" class="bg-blue-600 px-3 py-2 rounded">üé§ Speak</button>
  <button id="hearBtn" class="bg-green-600 px-3 py-2 rounded">üîä Hear AI</button>
  <button id="resetBtn" class="bg-red-600 px-3 py-2 rounded">‚ôªÔ∏è Reset</button>
</div>

<script>
/* ================= CONFIG ================= */
const WORKER_URL = "https://english-ai.xvbw97yrx9.workers.dev";
const LEVELS = ["A1","A2","B1","B2","C1"];

/* ================= STATE ================= */
let state = JSON.parse(localStorage.getItem("trainerState")) || {
  level: "A1",
  history: []
};

let lastUserSpeech = "";
let lastAIReply = "";
let audioUnlocked = false;

/* ================= DOM ================= */
const chat = document.getElementById("chat");
const levelText = document.getElementById("levelText");
const feedback = document.getElementById("feedback");

/* ================= VOZ NATURAL (IGUAL AO SISTEMA BOM) ================= */
let selectedVoice = null;

function initVoices() {
  const preferred = ['Samantha', 'Daniel', 'Aaron'];

  function pickVoice() {
    const voices = speechSynthesis.getVoices();
    if (!voices.length) return;

    selectedVoice =
      voices.find(v => preferred.includes(v.name) && v.lang.startsWith('en')) ||
      voices.find(v => v.lang === 'en-US') ||
      voices[0];
  }

  pickVoice();
  speechSynthesis.onvoiceschanged = pickVoice;
}

function speakText(text) {
  if (!text) return;
  speechSynthesis.cancel();
  speechSynthesis.resume();

  const u = new SpeechSynthesisUtterance(text);
  u.lang = 'en-US';
  if (selectedVoice) u.voice = selectedVoice;
  u.rate = 0.95;
  u.pitch = 1.0;

  speechSynthesis.speak(u);
}

initVoices();

/* ================= STT ================= */
document.getElementById("speakBtn").onclick = () => {
  const SR = window.webkitSpeechRecognition;
  if (!SR) return alert("Speech recognition not supported");

  const rec = new SR();
  rec.lang = "en-US";
  rec.interimResults = false;

  feedback.textContent = "üéôÔ∏è Listening‚Ä¶";

  rec.onresult = e => {
    lastUserSpeech = e.results[0][0].transcript.trim();
    addChat("You", lastUserSpeech);
    askAI(lastUserSpeech);
  };

  rec.start();
};

/* ================= NORMALIZA√á√ÉO / SIMILARIDADE ================= */
function normalize(t) {
  return t.toLowerCase().replace(/[^a-z']/g,' ').replace(/\s+/g,' ').trim();
}

function similarity(a,b) {
  let same = 0;
  for (let i=0;i<Math.min(a.length,b.length);i++)
    if (a[i]===b[i]) same++;
  return same / Math.max(a.length,b.length);
}

function highlight(target, spoken) {
  const t = normalize(target).split(' ');
  const s = normalize(spoken).split(' ');

  return t.map((w,i)=>{
    const score = similarity(w, s[i]||'');
    if (score >= 0.85) return `<span>${w}</span>`;
    const cls = score >= 0.5
      ? 'text-yellow-400 underline cursor-pointer'
      : 'text-red-400 underline cursor-pointer';
    return `<span class="${cls}" data-word="${w}">${w}</span>`;
  }).join(' ');
}

function attachWordListeners() {
  document.querySelectorAll('[data-word]').forEach(el=>{
    el.onclick = () => speakText(el.dataset.word);
  });
}

/* ================= AI (ROBUSTO, N√ÉO QUEBRA) ================= */
async function askAI(text) {
  feedback.textContent = "ü§ñ Thinking‚Ä¶";

  const prompt = `
Return a JSON object with:
correction, pronunciation, reply, cefr (0-1).

Student said: "${text}"
`;

  try {
    const res = await fetch(WORKER_URL,{
      method:"POST",
      headers:{ "Content-Type":"application/json" },
      body: JSON.stringify({ prompt })
    });

    const data = await res.json();
    let raw = data.reply || "";

    // Fallback seguro
    let parsed = {
      correction: raw,
      pronunciation: "Work on clarity and stress.",
      reply: raw,
      cefr: 0.5
    };

    // Extra√ß√£o tolerante de JSON
    try {
      const start = raw.indexOf("{");
      const end = raw.lastIndexOf("}");
      if (start !== -1 && end !== -1) {
        parsed = JSON.parse(raw.slice(start, end + 1));
      }
    } catch {}

    document.getElementById("correction").innerHTML =
      "<b>Correction:</b> " + highlight(parsed.correction, lastUserSpeech);
    attachWordListeners();

    document.getElementById("pronunciation").innerHTML =
      "<b>Pronunciation:</b> " + parsed.pronunciation;

    document.getElementById("reply").innerHTML =
      "<b>Reply:</b> " + parsed.reply;

    lastAIReply = parsed.reply;

    updateCEFR(Number(parsed.cefr) || 0.5);
    drawChart();

    if (audioUnlocked) speakText(lastAIReply);

    feedback.textContent = "Your turn.";

  } catch (e) {
    feedback.textContent = "AI unavailable.";
    console.error(e);
  }
}

/* ================= CEFR + GR√ÅFICO ================= */
function updateCEFR(score) {
  state.history.push(score);
  const recent = state.history.slice(-5);
  const avg = recent.reduce((a,b)=>a+b,0)/recent.length;

  const idx = Math.min(
    LEVELS.length-1,
    Math.max(0, Math.round(avg*(LEVELS.length-1)))
  );

  state.level = LEVELS[idx];
  localStorage.setItem("trainerState", JSON.stringify(state));
  levelText.textContent = "Level: " + state.level;
}

function drawChart() {
  const c = document.getElementById("chart");
  const ctx = c.getContext("2d");
  ctx.clearRect(0,0,c.width,c.height);

  ctx.strokeStyle = "#4ade80";
  ctx.beginPath();

  state.history.slice(-20).forEach((v,i)=>{
    const x = i*(c.width/20);
    const y = c.height - v*c.height;
    i ? ctx.lineTo(x,y) : ctx.moveTo(x,y);
  });

  ctx.stroke();
}

/* ================= UI ================= */
function addChat(who,text) {
  const d = document.createElement("div");
  d.className = who==="You" ? "text-blue-400" : "text-green-400";
  d.textContent = who + ": " + text;
  chat.appendChild(d);
  chat.scrollTop = chat.scrollHeight;
}

/* ================= AUDIO UNLOCK ================= */
document.getElementById("hearBtn").onclick = () => {
  if (!audioUnlocked) {
    speechSynthesis.speak(new SpeechSynthesisUtterance("."));
    audioUnlocked = true;
  }
  speakText(lastAIReply);
};

/* ================= RESET ================= */
document.getElementById("resetBtn").onclick = () => {
  if (confirm("Reset all progress?")) {
    localStorage.clear();
    location.reload();
  }
};
</script>

</body>
</html>
